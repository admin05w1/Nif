<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NEON GALAXY: ENDLESS CROWN</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #020205; font-family: 'Segoe UI', sans-serif; user-select: none; }
        
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&display=swap');
        
        /* UI KATMANI */
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column; padding: 25px; box-sizing: border-box; z-index: 10;
        }

        .top-bar { display: flex; justify-content: space-between; align-items: flex-start; }
        
        .stats-left { display: flex; flex-direction: column; gap: 15px; pointer-events: auto; }
        
        #score {
            font-family: 'Orbitron', sans-serif; font-size: 60px; font-weight: 900;
            color: white; text-shadow: 0 0 20px rgba(0,255,255,0.8); line-height: 1; pointer-events: none;
        }

        #hearts {
            font-size: 30px; letter-spacing: 5px; filter: drop-shadow(0 0 10px red); pointer-events: none;
        }

        /* KRAL TACI KUTUSU */
        .crown-box {
            background: linear-gradient(90deg, rgba(0,0,0,0.8), rgba(50,50,0,0.6));
            border: 2px solid #ffd700; border-radius: 15px; padding: 10px;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); width: fit-content;
            transition: transform 0.2s;
        }
        .crown-box:active { transform: scale(0.95); }
        
        .crown-icon { font-size: 24px; filter: drop-shadow(0 0 5px gold); }
        .crown-text { color: #ffd700; font-family: 'Orbitron'; font-size: 14px; font-weight: bold; }
        .crown-progress { color: white; font-size: 12px; font-family: 'Orbitron'; }

        .currency-box {
            background: rgba(0, 0, 0, 0.5); border: 1px solid #ff00de;
            padding: 10px 20px; border-radius: 30px; 
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 0 15px rgba(255, 0, 222, 0.3);
            pointer-events: auto; cursor: pointer;
        }

        /* BONUS EFEKTƒ∞ */
        #bonus-msg {
            position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%);
            font-family: 'Orbitron'; font-size: 30px; color: #ffd700; text-shadow: 0 0 30px orange;
            text-align: center; opacity: 0; pointer-events: none; transition: opacity 0.5s; z-index: 25;
            background: rgba(0,0,0,0.8); padding: 15px; border: 2px solid #ffd700; border-radius: 20px;
        }

        /* DAMAGE EFFECT */
        #damage-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 50%, rgba(255,0,0,0.8) 100%);
            opacity: 0; pointer-events: none; transition: opacity 0.2s; z-index: 5;
        }

        /* EKRANLAR */
        .screen {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; pointer-events: auto; z-index: 20; width: 100%; transition: opacity 0.5s;
        }
        .hidden { opacity: 0; pointer-events: none; }

        h1 {
            font-family: 'Orbitron'; font-size: 50px; margin-bottom: 10px;
            background: linear-gradient(to right, #00ff00, #ff00de); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 25px rgba(0,255,0,0.6)); letter-spacing: 5px;
        }

        .btn {
            background: rgba(0,0,0,0.8); border: 2px solid #00ffff; color: #00ffff;
            padding: 18px 40px; font-family: 'Orbitron'; font-size: 18px; font-weight: bold;
            cursor: pointer; margin: 8px; transition: 0.2s; border-radius: 50px;
            text-transform: uppercase; letter-spacing: 2px;
            box-shadow: 0 0 15px rgba(0,255,255,0.2);
            display: inline-block;
        }
        .btn:active { transform: scale(0.95); }
        .btn-shop { border-color: #ff00de; color: #ff00de; box-shadow: 0 0 15px rgba(255,0,222,0.2); }
        .btn-puzzle { border-color: #ffff00; color: #ffff00; box-shadow: 0 0 15px rgba(255,255,0,0.2); }
        
        /* MARKET MODAL */
        .modal {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; height: 85%; max-width: 800px;
            background: rgba(10, 10, 20, 0.98); border: 2px solid #00ffff;
            border-radius: 20px; padding: 20px; pointer-events: auto; z-index: 30;
            box-shadow: 0 0 100px rgba(0,0,0,1); overflow-y: auto;
        }
        
        .tab-menu { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: #555; font-family: 'Orbitron'; font-size: 18px; cursor: pointer; padding: 10px; transition: 0.3s; }
        .tab-btn.active { color: white; border-bottom: 2px solid #00ffff; text-shadow: 0 0 10px #00ffff; }

        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; padding-top: 10px; }
        
        .shop-item {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 15px; padding: 15px; text-align: center; cursor: pointer;
        }
        .shop-item.active { border: 2px solid #00ffff; background: rgba(0,255,255,0.1); }
        
        .preview-circle { width: 50px; height: 50px; border-radius: 50%; margin: 0 auto 10px; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.5); }
        
        /* BULMACA MODAL */
        #puzzle-content {
            display: flex; flex-direction: column; align-items: center; justify-content: center; height: 80%;
        }
        .scramble-text {
            font-family: 'Orbitron'; font-size: 32px; color: #ffff00; letter-spacing: 5px; margin: 15px 0;
            text-shadow: 0 0 20px #ffff00; text-align: center; word-wrap: break-word;
        }
        #puzzle-hint {
            font-family: 'Segoe UI', sans-serif; font-size: 16px; color: #00ffff; 
            margin-bottom: 20px; font-style: italic; opacity: 0.8;
        }
        #puzzle-input {
            background: rgba(0,0,0,0.5); border: 2px solid #ffff00; color: white;
            font-family: 'Orbitron'; font-size: 24px; padding: 10px; text-align: center;
            border-radius: 10px; width: 60%; margin-bottom: 20px; text-transform: uppercase;
        }
        
        #game-over-screen { background: rgba(0,0,0,0.9); padding: 40px; border-radius: 20px; border: 2px solid #ff00de; }

        /* Bƒ∞LGƒ∞ KUTUSU */
        #info-modal {
            display: none; position: absolute; top: 110px; left: 25px; width: 250px;
            background: rgba(0,0,0,0.9); border: 1px solid #ffd700; border-radius: 10px; padding: 15px;
            color: white; font-family: 'Segoe UI', sans-serif; font-size: 13px; z-index: 50;
            pointer-events: none;
        }
    </style>
</head>
<body>
<style>
    /* Fontu Y√ºkle */
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap');

    .back-home-btn {
        position: fixed; /* Sayfa kaydƒ±rƒ±lsa da sabit kalƒ±r */
        bottom: 20px;   /* A≈ûAƒûIDAN 20px bo≈üluk (Burayƒ± deƒüi≈ütirdik) */
        left: 20px;     /* SOLDAN 20px bo≈üluk */
        z-index: 9999;  /* En √ºstte g√∂r√ºns√ºn */
        
        background: rgba(0, 0, 0, 0.7); /* Arkasƒ± yarƒ± saydam siyah */
        border: 2px solid #ff00ff;      /* Pembe Neon √áer√ßeve */
        color: #ff00ff;                 /* Yazƒ± Rengi */
        
        padding: 12px 25px;
        font-family: 'Orbitron', sans-serif;
        font-size: 14px;
        font-weight: bold;
        text-transform: uppercase;
        text-decoration: none;
        letter-spacing: 2px;
        border-radius: 50px; /* Daha yuvarlak, kaps√ºl ≈üeklinde */
        transition: all 0.3s ease;
        
        /* Neon Parlama */
        box-shadow: 0 0 10px rgba(255, 0, 255, 0.4);
        text-shadow: 0 0 5px rgba(255, 0, 255, 0.8);
        
        display: flex;
        align-items: center;
        gap: 10px;
    }

    /* √úzerine gelince (Hover) */
    .back-home-btn:hover {
        background: #ff00ff;
        color: #000; /* Yazƒ± siyah olsun ki okunsun */
        box-shadow: 0 0 20px #ff00ff, 0 0 40px #ff00ff;
        transform: scale(1.05);
        cursor: pointer;
    }

    /* Mobilde biraz daha k√º√ß√ºk olsun */
    @media (max-width: 600px) {
        .back-home-btn {
            bottom: 15px;
            left: 15px;
            padding: 8px 15px;
            font-size: 11px;
        }
    }
</style>

<a href="index.html" class="back-home-btn">
    &#8678; ANA MEN√ú
</a>    <div id="damage-overlay"></div>
    <div id="bonus-msg">üëë TA√á KAZANDIN! üëë<br><span style="font-size:20px; color:white;">+50 ELMAS | TUR SIFIRLANDI</span></div>

    <div id="ui">
        <div class="top-bar">
            <div class="stats-left">
                <div id="score">0</div>
                <div id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                
                <div class="crown-box" onclick="toggleInfo()">
                    <span class="crown-icon">üëë</span>
                    <div>
                        <div class="crown-text">KRAL YOLU</div>
                        <div class="crown-progress"><span id="hoop-counter">0</span>/20 HALKA</div>
                    </div>
                </div>
                <div id="info-modal">
                    <strong>SONSUZ KRAL D√ñNG√úS√ú</strong><br><br>
                    Her 20 halkada bir, saya√ß sƒ±fƒ±rlanƒ±r ve <strong>+50 Elmas</strong> hesabƒ±na eklenir.<br><br>
                    Oyun durmaz! Yanana kadar ka√ß ta√ß toplayabilirsin?
                </div>

            </div>
            <div class="currency-box" onclick="openShop()">
                <span style="font-size:24px;">üíé</span>
                <span id="coin-display" style="font-family:'Orbitron'; color:white; font-size:20px;">0</span>
            </div>
        </div>
    </div>

    <div id="start-screen" class="screen">
        <h1>NEON<br><span style="font-size:24px; letter-spacing:10px; color:white;">ENDLESS LOOP</span></h1>
        <button class="btn" onclick="startGame()">BA≈ûLA</button>
        <br>
        <button class="btn btn-shop" onclick="openShop()">MARKET</button>
        <button class="btn btn-puzzle" onclick="openPuzzle()">BULMACA (+10üíé)</button>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h2 style="font-family:'Orbitron'; color:white; font-size:30px;">OYUN Bƒ∞TTƒ∞</h2>
        
        <div style="font-family:'Orbitron'; color:#aaa; margin-bottom:10px;">TOPLANAN TA√á: <span id="earned-crowns" style="color:#ffd700;">0</span> üëë</div>
        <div style="color:#aaa; margin-bottom:20px; font-family:'Orbitron';">TOPLAM KAZAN√á: <span id="earned-coins" style="color:#ff00de; font-size:24px;">0</span> üíé</div>
        
        <button class="btn" onclick="resetGame()">TEKRAR</button>
        <br>
        <button class="btn btn-shop" onclick="returnHome()">MEN√ú</button>
    </div>

    <div id="shop-modal" class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:white; font-family:'Orbitron'; margin:0;">MARKET</h2>
            <span onclick="closeModal('shop-modal')" style="color:white; font-size:30px; cursor:pointer;">&times;</span>
        </div>
        
        <div class="tab-menu">
            <button id="tab-chars" class="tab-btn active" onclick="switchTab('chars')">KARAKTERLER</button>
            <button id="tab-arenas" class="tab-btn" onclick="switchTab('arenas')">ARENALAR</button>
        </div>

        <div class="shop-grid" id="shop-grid"></div>
    </div>

    <div id="puzzle-modal" class="modal" style="border-color: #ffff00;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2 style="color:#ffff00; font-family:'Orbitron'; margin:0;">UZAY Bƒ∞LGƒ∞Sƒ∞</h2>
            <span onclick="closeModal('puzzle-modal')" style="color:white; font-size:30px; cursor:pointer;">&times;</span>
        </div>
        <div id="puzzle-content">
            <div id="puzzle-info-text" style="color:#aaa; font-family:'Orbitron';">KARI≈ûIK HARFLER:</div>
            <div id="scramble-word" class="scramble-text">???</div>
            <div id="puzzle-hint">ƒ∞pucu: Burada ipucu yazacak...</div>
            
            <input type="text" id="puzzle-input" placeholder="CEVABI YAZ...">
            <button id="puzzle-btn" class="btn btn-puzzle" onclick="checkPuzzle()">KONTROL ET (+10 üíé)</button>
            <div id="puzzle-msg" style="height:30px; margin-top:10px; font-family:'Orbitron'; font-weight:bold;"></div>
            <div style="margin-top:20px; color:#555; font-size:12px;">KALAN SORU: <span id="words-left">50</span>/50</div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- AYARLAR ---
        const GAME_SPEED = 0.12;
        const GRAVITY = -0.014;
        const JUMP_FORCE = 0.35;
        const HOOP_GAP = 18.0;
        const HOOP_RADIUS = 2.3;
        const GEM_REWARD = 10; 
        const CROWN_GOAL = 20; // 20 Halkada bir sƒ±fƒ±rlanacak

        // --- E≈ûYALAR ---
        const items = [
            { id: 0, name: "Neon", price: 0, type: 'standard', color: 0xffffff },
            { id: 1, name: "Mars", price: 50, type: 'standard', color: 0xff3300 },
            { id: 8, name: "Alien V1", price: 150, type: 'alien', color: 0x33ff33 },
            { id: 9, name: "Alien King", price: 300, type: 'alien_king', color: 0x9900ff },
            { id: 2, name: "Buz Devi", price: 200, type: 'standard', color: 0x00ffff },
            { id: 7, name: "UFO V1", price: 500, type: 'spaceship', color: 0x888888, glowColor: 0x00ff00 },
            { id: 10, name: "Explorer", price: 750, type: 'spaceship_v2', color: 0xffaa00, glowColor: 0xffffff },
            { id: 3, name: "Siber", price: 600, type: 'cyber', color: 0x00ff00 },
            { id: 4, name: "Kristal", price: 800, type: 'crystal', color: 0xff00de },
            { id: 5, name: "G√ºne≈ü", price: 1200, type: 'glow', color: 0xffaa00, glowColor: 0xff4400 },
            { id: 6, name: "Kara Delik", price: 2500, type: 'blackhole', color: 0x000000, glowColor: 0xaa00ff }
        ];

        // --- ARKA PLANLAR ---
        const backgrounds = [
            { id: 0, name: "Klasik Uzay", price: 0, fogColor: 0x020205, gridColor: 0xff00de, starColor: 0x888888, hoopColor: 0x00ffff, obsColor: 0xff0000 },
            { id: 1, name: "Kƒ±zƒ±l Nebula", price: 2500, fogColor: 0x220000, gridColor: 0xff3300, starColor: 0xffaaaa, hoopColor: 0xff0000, obsColor: 0xffaa00 },
            { id: 2, name: "Zehirli Galaksi", price: 3500, fogColor: 0x001100, gridColor: 0x00ff00, starColor: 0xccffcc, hoopColor: 0x00ff00, obsColor: 0x9900ff },
            { id: 3, name: "Mavi Derinlik", price: 4000, fogColor: 0x000022, gridColor: 0x00ffff, starColor: 0xaaccff, hoopColor: 0x0088ff, obsColor: 0xffff00 },
            { id: 4, name: "Altƒ±n √áaƒü", price: 7500, fogColor: 0x221100, gridColor: 0xffcc00, starColor: 0xffffaa, hoopColor: 0xffd700, obsColor: 0xffffff }
        ];

        // --- BULMACA Lƒ∞STESƒ∞ ---
        const masterWordList = [
            { word: "MERK√úR", hint: "G√ºne≈ü'e en yakƒ±n gezegen." },
            { word: "VEN√úS", hint: "D√ºnya'nƒ±n ikizi olarak bilinir, √ßok sƒ±caktƒ±r." },
            { word: "D√úNYA", hint: "√úzerinde ya≈üadƒ±ƒüƒ±mƒ±z mavi gezegen." },
            { word: "MARS", hint: "Kƒ±zƒ±l Gezegen." },
            { word: "J√úPƒ∞TER", hint: "G√ºne≈ü Sistemi'nin en b√ºy√ºk gezegeni." },
            { word: "SAT√úRN", hint: "Halkalarƒ±yla √ºnl√º gezegen." },
            { word: "G√úNE≈û", hint: "Isƒ± ve ƒ±≈üƒ±k kaynaƒüƒ±mƒ±z olan yƒ±ldƒ±z." },
            { word: "AY", hint: "D√ºnya'nƒ±n doƒüal uydusu." },
            { word: "GALAKSƒ∞", hint: "Milyarlarca yƒ±ldƒ±zƒ±n olu≈üturduƒüu k√ºme." },
            { word: "ASTRONOT", hint: "Uzaya giden insan." },
            { word: "ROKET", hint: "Uzaya gitmek i√ßin kullanƒ±lan ara√ß." },
            { word: "TELESKOP", hint: "Yƒ±ldƒ±zlarƒ± g√∂zlemlemek i√ßin kullanƒ±lan alet." },
            { word: "KARADELƒ∞K", hint: "I≈üƒ±ƒüƒ± bile yutan kozmik yapƒ±." },
            { word: "OKSƒ∞JEN", hint: "Uzayda olmayan, nefes almamƒ±zƒ± saƒülayan gaz." },
            { word: "METEOR", hint: "D√ºnya atmosferine giren g√∂k ta≈üƒ±." },
            { word: "UFO", hint: "Tanƒ±mlanamayan u√ßan cisim." },
            { word: "SAMANYOLU", hint: "ƒ∞√ßinde bulunduƒüumuz galaksi." },
            { word: "YER√áEKƒ∞Mƒ∞", hint: "Bizi yere basan kuvvet." },
            { word: "UZAYLI", hint: "Ba≈üka gezegenlerde ya≈üadƒ±ƒüƒ± d√º≈ü√ºn√ºlen canlƒ±." },
            { word: "KUYRUKLUYILDIZ", hint: "Arkasƒ±nda iz bƒ±rakan buz ve toz k√ºtlesi." }
        ];
        
        let availableWords = [...masterWordList];
        let currentPuzzle = null; 

        let scene, camera, renderer, composer;
        let ball, ballMesh, ballInner;
        let hoops = [];
        let obstacles = [];
        let particles = [];
        let gridFloor, gridCeiling, starSystem;
        let activeTab = 'chars'; 

        let playerData = { coins: 0, inventory: [0], bgInventory: [0], equipped: 0, equippedBg: 0, solvedPuzzles: [] };
        
        // currentCycleHoops: 0'dan 20'ye kadar sayar, sonra sƒ±fƒ±rlanƒ±r
        // totalCrowns: O seansta ka√ß kere 20 yapƒ±ldƒ±ƒüƒ±nƒ± sayar
        let gameState = { playing: false, over: false, score: 0, sessionCoins: 0, velocityY: 0, lives: 3, currentCycleHoops: 0, totalCrowns: 0 };

        loadData();
        init();
        animate();

        function loadData() {
            const saved = localStorage.getItem('neonGalaxyV6Data');
            if (saved) {
                const loaded = JSON.parse(saved);
                playerData = { ...playerData, ...loaded };
                if(!playerData.solvedPuzzles) playerData.solvedPuzzles = [];
                availableWords = masterWordList.filter(item => !playerData.solvedPuzzles.includes(item.word));
                if(!playerData.bgInventory) { playerData.bgInventory = [0]; playerData.equippedBg = 0; }
            }
            updateUI();
        }
        function saveData() {
            localStorage.setItem('neonGalaxyV6Data', JSON.stringify(playerData));
            updateUI();
        }
        function updateUI() {
            document.getElementById('coin-display').innerText = playerData.coins;
        }

        function init() {
            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 300);
            camera.position.set(0, 0, 14);

            renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.toneMapping = THREE.ReinhardToneMapping;
            document.body.appendChild(renderer.domElement);

            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.threshold = 0;
            bloomPass.strength = 1.4;
            bloomPass.radius = 0.5;
            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            scene.add(new THREE.AmbientLight(0x404040));
            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(5, 10, 5);
            scene.add(dirLight);

            createBackground(); 
            createPlayerBall();

            window.addEventListener('mousedown', jump);
            window.addEventListener('touchstart', (e) => { 
                if(e.target.tagName !== 'INPUT') { e.preventDefault(); jump(); }
            }, {passive: false});
            window.addEventListener('resize', onResize);
            
            window.startGame = startGame;
            window.resetGame = resetGame;
            window.returnHome = returnHome;
            window.openShop = openShop;
            window.closeModal = closeModal;
            window.buyItem = buyItem;
            window.buyBackground = buyBackground;
            window.openPuzzle = openPuzzle;
            window.checkPuzzle = checkPuzzle;
            window.switchTab = switchTab;
            window.toggleInfo = toggleInfo;
        }

        function createBackground() {
            if(starSystem) scene.remove(starSystem);
            if(gridFloor) scene.remove(gridFloor);
            if(gridCeiling) scene.remove(gridCeiling);

            const bgData = backgrounds.find(b => b.id === playerData.equippedBg) || backgrounds[0];

            scene.fog = new THREE.FogExp2(bgData.fogColor, 0.02);
            renderer.setClearColor(bgData.fogColor);

            const geo = new THREE.BufferGeometry();
            const pos = [];
            for(let i=0; i<1500; i++) pos.push((Math.random()-0.5)*200, (Math.random()-0.5)*200, (Math.random()-0.5)*100-50);
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({color: bgData.starColor, size: 0.15});
            starSystem = new THREE.Points(geo, mat);
            scene.add(starSystem);

            const gridGeo = new THREE.PlaneGeometry(300, 300, 50, 50);
            const gridMat = new THREE.MeshBasicMaterial({ color: bgData.gridColor, wireframe: true, transparent: true, opacity: 0.2 });
            
            gridFloor = new THREE.Mesh(gridGeo, gridMat);
            gridFloor.rotation.x = -Math.PI / 2;
            gridFloor.position.y = -12; 
            scene.add(gridFloor);

            gridCeiling = gridFloor.clone();
            gridCeiling.position.y = 12;
            scene.add(gridCeiling);
        }

        function createPlayerBall() {
            if(ball) scene.remove(ball);
            const item = items.find(i => i.id === playerData.equipped);
            ball = new THREE.Group();
            
            let geo, mat;

            if (item.type === 'alien' || item.type === 'alien_king') {
                const headColor = item.type === 'alien_king' ? 0x9900ff : 0x33ff33;
                const headGeo = new THREE.SphereGeometry(0.45, 32, 32);
                const headMat = new THREE.MeshStandardMaterial({ color: headColor, roughness: 0.3 });
                ballMesh = new THREE.Mesh(headGeo, headMat);
                const eyeGeo = new THREE.SphereGeometry(0.12, 16, 16); const eyeMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
                const leftEye = new THREE.Mesh(eyeGeo, eyeMat); leftEye.position.set(-0.15, 0.1, 0.35); leftEye.scale.set(1, 1.8, 0.5); leftEye.rotation.z = 0.4;
                const rightEye = leftEye.clone(); rightEye.position.set(0.15, 0.1, 0.35); rightEye.rotation.z = -0.4;
                if (item.type === 'alien_king') {
                    const thirdEye = new THREE.Mesh(new THREE.SphereGeometry(0.1), new THREE.MeshBasicMaterial({color:0xff0000})); thirdEye.position.set(0, 0.3, 0.38); ballMesh.add(thirdEye);
                    const crownGeo = new THREE.CylinderGeometry(0.2, 0.2, 0.1, 6); const crownMat = new THREE.MeshBasicMaterial({color: 0xffd700}); const crown = new THREE.Mesh(crownGeo, crownMat); crown.position.set(0, 0.55, 0); ballMesh.add(crown);
                }
                ballMesh.add(leftEye); ballMesh.add(rightEye);
            } else if (item.type === 'spaceship' || item.type === 'spaceship_v2') {
                const bodyColor = item.type === 'spaceship_v2' ? 0xffaa00 : 0x444444;
                const bodyGeo = new THREE.CylinderGeometry(0.1, 0.6, 0.2, 32); const bodyMat = new THREE.MeshStandardMaterial({ color: bodyColor, metalness: 0.8 }); ballMesh = new THREE.Mesh(bodyGeo, bodyMat);
                const glassGeo = new THREE.SphereGeometry(0.25, 32, 16, 0, Math.PI * 2, 0, Math.PI/2); const glassMat = new THREE.MeshBasicMaterial({ color: 0x00ffff }); const glass = new THREE.Mesh(glassGeo, glassMat); glass.position.y = 0.05; ballMesh.add(glass);
                const engineGeo = new THREE.TorusGeometry(0.3, 0.02, 16, 32); const engineMat = new THREE.MeshBasicMaterial({ color: item.glowColor }); const engine = new THREE.Mesh(engineGeo, engineMat); engine.rotation.x = Math.PI / 2; engine.position.y = -0.1; ballMesh.add(engine);
                if (item.type === 'spaceship_v2') { const wingGeo = new THREE.BoxGeometry(1.2, 0.05, 0.2); const wing = new THREE.Mesh(wingGeo, bodyMat); wing.position.y = 0; ballMesh.add(wing); }
                ballMesh.rotation.z = -0.1;
            } else if (item.type === 'blackhole') {
                const coreGeo = new THREE.SphereGeometry(0.35, 32, 32); const coreMat = new THREE.MeshBasicMaterial({ color: 0x000000 }); ballMesh = new THREE.Mesh(coreGeo, coreMat);
                const ringGeo = new THREE.TorusGeometry(0.6, 0.05, 16, 50); const ringMat = new THREE.MeshBasicMaterial({ color: item.glowColor }); ballInner = new THREE.Mesh(ringGeo, ringMat); ballInner.rotation.x = Math.PI / 2; ballMesh.add(ballInner);
                const light = new THREE.PointLight(item.glowColor, 2, 8); ball.add(light);
            } else if (item.type === 'cyber') {
                const coreGeo = new THREE.SphereGeometry(0.25, 16, 16); const coreMat = new THREE.MeshBasicMaterial({ color: 0xffffff }); ballInner = new THREE.Mesh(coreGeo, coreMat); ball.add(ballInner);
                geo = new THREE.SphereGeometry(0.45, 16, 16); mat = new THREE.MeshBasicMaterial({ color: item.color, wireframe: true }); ballMesh = new THREE.Mesh(geo, mat);
            } else if (item.type === 'crystal') {
                geo = new THREE.IcosahedronGeometry(0.45, 0); mat = new THREE.MeshStandardMaterial({ color: item.color, roughness: 0.1, metalness: 0.9, flatShading: true, emissive: 0x440044, emissiveIntensity: 0.5 }); ballMesh = new THREE.Mesh(geo, mat);
            } else if (item.type === 'glow') {
                geo = new THREE.SphereGeometry(0.45, 32, 32); mat = new THREE.MeshBasicMaterial({ color: item.glowColor }); ballMesh = new THREE.Mesh(geo, mat); const light = new THREE.PointLight(item.glowColor, 3, 10); ball.add(light);
            } else {
                geo = new THREE.SphereGeometry(0.45, 32, 32); mat = new THREE.MeshStandardMaterial({ color: item.color, roughness: 0.4, metalness: 0.2, emissive: item.color, emissiveIntensity: 0.2 }); ballMesh = new THREE.Mesh(geo, mat);
            }

            ball.add(ballMesh);
            ball.position.set(-4, 0, 0);
            scene.add(ball);
        }

        function startGame() {
            document.getElementById('start-screen').classList.add('hidden');
            resetLogic();
            gameState.playing = true;
            createHoop(5);
            createHoop(5 + HOOP_GAP);
            jump();
        }

        function resetLogic() {
            hoops.forEach(h => scene.remove(h)); hoops = [];
            obstacles.forEach(o => scene.remove(o)); obstacles = [];
            particles.forEach(p => scene.remove(p.mesh)); particles = [];
            
            ball.position.set(-4, 0, 0); ball.rotation.set(0,0,0); ball.visible = true;
            gameState.velocityY = 0; gameState.score = 0; gameState.sessionCoins = 0; gameState.over = false; gameState.lives = 3; 
            gameState.currentCycleHoops = 0; // ≈ûimdiki d√∂ng√º
            gameState.totalCrowns = 0; // Toplam ta√ß
            
            document.getElementById('score').innerText = 0;
            document.getElementById('hoop-counter').innerText = 0;
            updateHearts();
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('damage-overlay').style.opacity = 0;
        }

        function updateHearts() {
            let h = ""; for(let i=0; i<gameState.lives; i++) h += "‚ù§Ô∏è"; document.getElementById('hearts').innerText = h;
        }

        function jump() {
            if(gameState.over) return;
            if(document.getElementById('start-screen').classList.contains('hidden') === false) return;
            if(document.getElementById('puzzle-modal').style.display === 'block') return;

            gameState.velocityY = JUMP_FORCE;
            if(ballMesh) {
                const item = items.find(i => i.id === playerData.equipped);
                if(!item.type.includes('spaceship')) { ballMesh.scale.set(0.8, 1.2, 0.8); setTimeout(() => ballMesh.scale.set(1,1,1), 100); }
                else { ballMesh.rotation.x = -0.3; setTimeout(() => ballMesh.rotation.x = 0, 200); }
            }
        }

        function createObstacle(x) {
            const bgData = backgrounds.find(b => b.id === playerData.equippedBg) || backgrounds[0];
            const geo = new THREE.IcosahedronGeometry(0.6, 0);
            const mat = new THREE.MeshStandardMaterial({ color: bgData.obsColor, emissive: bgData.obsColor, emissiveIntensity: 0.5, roughness: 0.5, metalness: 0.8, flatShading: true });
            const obs = new THREE.Mesh(geo, mat);
            const yPos = (Math.random() * 8) - 4; obs.position.set(x, yPos, 0); obs.userData = { rotSpeed: Math.random() * 0.1, active: true };
            scene.add(obs); obstacles.push(obs);
        }

        function createHoop(x) {
            const bgData = backgrounds.find(b => b.id === playerData.equippedBg) || backgrounds[0];
            const group = new THREE.Group();
            const geo = new THREE.TorusGeometry(HOOP_RADIUS, 0.08, 12, 48);
            const mat = new THREE.MeshStandardMaterial({ color: bgData.hoopColor, emissive: bgData.hoopColor, emissiveIntensity: 1 });
            const ring = new THREE.Mesh(geo, mat);
            ring.rotation.x = Math.PI / 2; ring.rotation.y = 0.2; group.add(ring);
            
            group.position.set(x, (Math.random() * 6) - 3, 0);
            group.userData = { passed: false, checked: false };
            scene.add(group); hoops.push(group);

            if(Math.random() > 0.4) createObstacle(x + (HOOP_GAP / 2));
        }

        function spawnExplosion(pos, color) {
            for(let i=0; i<20; i++) {
                const geo = new THREE.BoxGeometry(0.15, 0.15, 0.15); const mat = new THREE.MeshBasicMaterial({ color: color }); const p = new THREE.Mesh(geo, mat);
                p.position.copy(pos); p.userData.vel = new THREE.Vector3((Math.random()-0.5), (Math.random()-0.5), (Math.random()-0.5)); p.userData.life = 1.0;
                scene.add(p); particles.push(p);
            }
        }

        function loseLife() {
            gameState.lives--; updateHearts();
            const overlay = document.getElementById('damage-overlay'); overlay.style.opacity = 1; setTimeout(() => { overlay.style.opacity = 0; }, 200);
            if(gameState.lives <= 0) gameOver();
        }

        function gameOver() {
            gameState.over = true; gameState.playing = false;
            playerData.coins += gameState.sessionCoins; saveData();
            
            document.getElementById('earned-coins').innerText = gameState.sessionCoins;
            document.getElementById('earned-crowns').innerText = gameState.totalCrowns; // Kazanƒ±lan Ta√ßlarƒ± G√∂ster
            document.getElementById('game-over-screen').classList.remove('hidden');
            
            const item = items.find(i => i.id === playerData.equipped);
            const explosionColor = item.glowColor || item.color;
            spawnExplosion(ball.position, explosionColor);
            ball.visible = false;
        }

        // --- CROWN BONUS ---
        function triggerBonus() {
            const msg = document.getElementById('bonus-msg');
            msg.style.opacity = 1;
            gameState.sessionCoins += 50; // Bonus elmas eklendi
            gameState.totalCrowns++; // Ta√ß sayƒ±sƒ±nƒ± artƒ±r
            
            document.getElementById('coin-display').innerText = playerData.coins + gameState.sessionCoins;
            
            setTimeout(() => { msg.style.opacity = 0; }, 2000);
        }

        function animate() {
            requestAnimationFrame(animate);

            if(gameState.playing && !gameState.over) {
                gameState.velocityY += GRAVITY; ball.position.y += gameState.velocityY;
                const item = items.find(i => i.id === playerData.equipped);
                
                if(!item.type.includes('spaceship') && !item.type.includes('alien')) ball.rotation.x -= 0.05;
                if(item.type.includes('alien')) ball.rotation.x = Math.sin(Date.now()*0.005) * 0.2;
                if(item.type === 'blackhole' && ballInner) ballInner.rotation.z += 0.1;
                if(item.type === 'cyber' && ballMesh) ballMesh.rotation.y += 0.1;
                if(item.type.includes('spaceship') && ballMesh) ballMesh.rotation.y += 0.02;

                if(ball.position.y < -8 || ball.position.y > 8) { loseLife(); ball.position.y = 0; gameState.velocityY = 0; }

                if(gridFloor) {
                    gridFloor.position.x -= GAME_SPEED; if(gridFloor.position.x < -100) gridFloor.position.x = 0; 
                    scene.children.forEach(c => { if(c !== gridFloor && c.geometry && c.geometry.type === 'PlaneGeometry') { c.position.x = gridFloor.position.x; } });
                }

                for(let i=obstacles.length-1; i>=0; i--) {
                    const obs = obstacles[i]; obs.position.x -= GAME_SPEED; obs.rotation.x += obs.userData.rotSpeed; obs.rotation.y += obs.userData.rotSpeed;
                    const dist = ball.position.distanceTo(obs.position);
                    if(dist < 0.9 && obs.userData.active) {
                        obs.userData.active = false; spawnExplosion(obs.position, 0xff0000); scene.remove(obs); obstacles.splice(i, 1); loseLife(); gameState.velocityY = 0.2; 
                    } else if (obs.position.x < -12) { scene.remove(obs); obstacles.splice(i, 1); }
                }

                for(let i=hoops.length-1; i>=0; i--) {
                    const h = hoops[i]; h.position.x -= GAME_SPEED;
                    const dx = Math.abs(h.position.x - ball.position.x);
                    const dy = Math.abs(h.position.y - ball.position.y);

                    if(dx < 1.0 && !h.userData.passed) {
                        if(gameState.velocityY < 0 && dy < 2.0) {
                            // PUAN KAZANMA
                            gameState.score++; gameState.sessionCoins += GEM_REWARD;
                            gameState.currentCycleHoops++; // D√∂ng√º sayacƒ±nƒ± artƒ±r
                            
                            // TA√á KONTROL√ú (SONSUZ D√ñNG√ú)
                            if(gameState.currentCycleHoops >= CROWN_GOAL) {
                                gameState.currentCycleHoops = 0; // SIFIRLA
                                triggerBonus(); // √ñd√ºl ver ve Efekt G√∂ster
                            }

                            // UI G√ºncelle
                            document.getElementById('score').innerText = gameState.score; 
                            document.getElementById('coin-display').innerText = playerData.coins + gameState.sessionCoins;
                            document.getElementById('hoop-counter').innerText = gameState.currentCycleHoops;
                            
                            // G√ñRSEL EFEKTLER
                            h.userData.passed = true; h.userData.checked = true; h.children[0].material.emissive.setHex(0x00ff00); 
                            const explosionColor = item.glowColor || item.color;
                            spawnExplosion(ball.position, explosionColor);
                        }
                    }

                    if (h.position.x < ball.position.x - 2 && !h.userData.passed && !h.userData.checked) {
                        h.userData.checked = true; h.children[0].material.emissive.setHex(0xff0000); loseLife();
                    }

                    if(h.position.x < -12) { scene.remove(h); hoops.splice(i, 1); const lastX = hoops.length > 0 ? hoops[hoops.length-1].position.x : 5; createHoop(lastX + HOOP_GAP); }
                }
                
                if(hoops.length > 0 && hoops[hoops.length-1].position.x < 15) { createHoop(hoops[hoops.length-1].position.x + HOOP_GAP); }
            }

            for(let i=particles.length-1; i>=0; i--) {
                const p = particles[i]; p.position.add(p.userData.vel); p.rotation.x += 0.1; p.userData.life -= 0.02; p.scale.setScalar(p.userData.life);
                if(p.userData.life <= 0) { scene.remove(p); particles.splice(i, 1); }
            }
            composer.render();
        }

        // --- BULMACA MANTIƒûI ---
        function openPuzzle() {
            document.getElementById('words-left').innerText = availableWords.length;
            if(availableWords.length === 0) {
                document.getElementById('puzzle-info-text').innerText = "T√úM BULMACALAR √á√ñZ√úLD√ú"; document.getElementById('scramble-word').innerText = "HAKKINIZ Bƒ∞TTƒ∞"; document.getElementById('puzzle-hint').innerText = ""; document.getElementById('puzzle-input').style.display = 'none'; document.getElementById('puzzle-btn').style.display = 'none'; document.getElementById('puzzle-modal').style.display = 'block'; return;
            }
            const randomIndex = Math.floor(Math.random() * availableWords.length);
            currentPuzzle = availableWords[randomIndex];
            let shuffled = currentPuzzle.word.split('').sort(() => 0.5 - Math.random()).join(' ');
            document.getElementById('puzzle-info-text').innerText = "KARI≈ûIK HARFLER:"; document.getElementById('scramble-word').innerText = shuffled; document.getElementById('puzzle-hint').innerText = "ƒ∞pucu: " + currentPuzzle.hint; document.getElementById('puzzle-input').style.display = 'block'; document.getElementById('puzzle-btn').style.display = 'inline-block'; document.getElementById('puzzle-input').value = ""; document.getElementById('puzzle-msg').innerText = ""; document.getElementById('puzzle-modal').style.display = 'block';
        }

        function checkPuzzle() {
            const input = document.getElementById('puzzle-input').value.toUpperCase().trim();
            const msg = document.getElementById('puzzle-msg');
            if (input === currentPuzzle.word) {
                msg.style.color = "#00ff00"; msg.innerText = "DOƒûRU! +10 ELMAS";
                playerData.coins += 10;
                playerData.solvedPuzzles.push(currentPuzzle.word);
                availableWords = masterWordList.filter(item => !playerData.solvedPuzzles.includes(item.word));
                saveData(); setTimeout(() => closeModal('puzzle-modal'), 1000);
            } else { msg.style.color = "red"; msg.innerText = "YANLI≈û, TEKRAR DENE!"; }
        }

        // --- MARKET Sƒ∞STEMƒ∞ ---
        function switchTab(tab) { activeTab = tab; document.getElementById('tab-chars').className = activeTab === 'chars' ? 'tab-btn active' : 'tab-btn'; document.getElementById('tab-arenas').className = activeTab === 'arenas' ? 'tab-btn active' : 'tab-btn'; openShop(); }

        function openShop() {
            const grid = document.getElementById('shop-grid'); grid.innerHTML = "";
            if (activeTab === 'chars') {
                items.forEach(item => { const owned = playerData.inventory.includes(item.id); const equipped = playerData.equipped === item.id; createShopItem(grid, item, owned, equipped, 'char'); });
            } else {
                backgrounds.forEach(bg => { const owned = playerData.bgInventory.includes(bg.id); const equipped = playerData.equippedBg === bg.id; createShopItem(grid, bg, owned, equipped, 'arena'); });
            }
            document.getElementById('shop-modal').style.display = 'block';
        }

        function createShopItem(grid, item, owned, equipped, type) {
            const div = document.createElement('div'); div.className = `shop-item ${equipped ? 'active' : ''}`; div.onclick = () => type === 'char' ? buyItem(item.id) : buyBackground(item.id);
            let previewStyle = "";
            if (type === 'char') {
                previewStyle = `background-color: #${item.color ? item.color.toString(16).padStart(6,'0') : 'fff'};`;
                if(item.type.includes('alien')) previewStyle = `background: radial-gradient(circle, #33ff33 30%, #000 90%); border: 2px solid #33ff33;`;
                if(item.type.includes('spaceship')) previewStyle = `background: radial-gradient(circle, #00ffff 10%, #444444 60%); border: 2px solid #00ffff;`;
                if(item.type === 'blackhole') previewStyle = `background: black; border: 2px solid #${item.glowColor.toString(16).padStart(6,'0')}; box-shadow: 0 0 10px #${item.glowColor.toString(16).padStart(6,'0')};`;
            } else {
                previewStyle = `background: linear-gradient(45deg, #${item.fogColor.toString(16).padStart(6,'0')}, #${item.gridColor.toString(16).padStart(6,'0')}); border: 1px solid white;`;
            }
            div.innerHTML = `
                <div class="preview-circle" style="${previewStyle}"></div>
                <div style="color:white; font-weight:bold; font-size:14px;">${item.name}</div>
                ${owned ? `<div style="color:#00ff00; font-size:12px; margin-top:5px;">${equipped ? 'SE√áƒ∞Lƒ∞' : 'SAHƒ∞PSƒ∞N'}</div>` : `<div style="color:#ff00de; font-weight:bold; margin-top:5px;">${item.price} üíé</div>`}
            `;
            grid.appendChild(div);
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        function buyItem(id) {
            const item = items.find(i => i.id === id);
            if (playerData.inventory.includes(id)) { playerData.equipped = id; saveData(); createPlayerBall(); openShop(); }
            else if (playerData.coins >= item.price) { playerData.coins -= item.price; playerData.inventory.push(id); playerData.equipped = id; saveData(); createPlayerBall(); openShop(); }
        }

        function buyBackground(id) {
            const bg = backgrounds.find(b => b.id === id);
            if (playerData.bgInventory.includes(id)) { playerData.equippedBg = id; saveData(); createBackground(); openShop(); }
            else if (playerData.coins >= bg.price) { playerData.coins -= bg.price; playerData.bgInventory.push(id); playerData.equippedBg = id; saveData(); createBackground(); openShop(); }
        }
        
        function toggleInfo() { const modal = document.getElementById('info-modal'); modal.style.display = modal.style.display === 'block' ? 'none' : 'block'; }
        function onResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight); }
        function resetGame() { resetLogic(); gameState.playing = true; createHoop(5); createHoop(5+HOOP_GAP); jump(); }
        function returnHome() { resetLogic(); document.getElementById('start-screen').classList.remove('hidden'); }
    </script>
</body>
</html>
